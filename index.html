<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöß Pothole Detection Map üöß</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            transition: background-color 0.3s, color 0.3s;
        }

        h2 {
            margin: 20px 0;
            color: #333;
        }

        #map {
            height: 600px;
            width: 100%;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .leaflet-popup-content {
            font-size: 14px;
            text-align: center;
        }

        .leaflet-popup-content b {
            color: red;
        }

        .locate-btn {
            margin: 10px;
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .locate-btn:hover {
            background-color: #0056b3;
        }

        #loading {
            font-size: 18px;
            color: gray;
            margin-top: 10px;
        }

        /* Sidebar Styles */
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 300px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transform: translateX(-100%);
            transition: transform 0.3s;
            z-index: 1000;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: #007bff;
            color: white;
        }

        .stats-box {
            padding: 1rem;
            background: #f8f9fa;
            margin: 1rem;
            border-radius: 8px;
        }

        .filters {
            padding: 1rem;
        }

        /* Dark Mode Styles */
        .dark-mode {
            background-color: #2c3e50;
            color: #ecf0f1;
        }

        .leaflet-dark {
            filter: grayscale(1) invert(1);
        }

        /* Floating Buttons */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .floating-btn.secondary {
            right: 90px;
        }

        /* Report Form */
        #report-form {
            display: none;
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        #report-form input {
            display: block;
            margin: 0.5rem 0;
            padding: 0.5rem;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #report-form button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h2>üöß Pothole Detection Map üöß</h2>
<button class="locate-btn" onclick="locateUser()">üìç Find My Location</button>
<button class="locate-btn" onclick="toggleDarkMode()">üåì Toggle Dark Mode</button>
<div id="loading">Loading pothole data...</div>
<div id="map"></div>

<!-- Sidebar -->
<div id="sidebar">
    <div class="sidebar-header">
        <h3>üöß Pothole Analytics</h3>
        <button class="close-btn" onclick="toggleSidebar()">√ó</button>
    </div>
    <div class="sidebar-content">
        <div class="stats-box">
            <h4>üìä Statistics</h4>
            <p>Total Potholes: <span id="total-count">0</span></p>
            <p>Avg. Depth: <span id="avg-depth">0 cm</span></p>
            <p>Most Affected Area: <span id="hotspot">-</span></p>
        </div>
        <div class="filters">
            <h4>üîç Filters</h4>
            <label><input type="checkbox" id="show-critical"> Show Critical (Ôºû15cm)</label>
            <label><input type="checkbox" id="show-user-loc"> Show Nearby (Ôºú1km)</label>
            <input type="date" id="date-filter" class="date-picker">
        </div>
    </div>
</div>

<!-- Floating Buttons -->
<div class="floating-btn" onclick="toggleSidebar()">‚ò∞</div>
<div class="floating-btn secondary" onclick="showReportForm()">+</div>

<!-- Report Form -->
<div id="report-form">
    <h3>Report New Pothole</h3>
    <input type="number" step="0.000001" id="report-lat" placeholder="Latitude">
    <input type="number" step="0.000001" id="report-lon" placeholder="Longitude">
    <input type="number" id="report-depth" placeholder="Depth (cm)">
    <button onclick="submitReport()">Submit</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    // Initialize Map
    var map = L.map('map').setView([20.5937, 78.9629], 5); // Default to India

    // Add OpenStreetMap Tiles
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marker Cluster Group
    var markers = L.markerClusterGroup();
    var userMarker = null;
    var accuracyCircle = null;

    // Icons
    var potholeIcon = L.icon({
        iconUrl: 'assets/images/pothole.png',
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
    });

    var userIcon = L.icon({
        iconUrl: 'assets/images/location.png',
        iconSize: [25, 25],
        iconAnchor: [12, 12],
        popupAnchor: [0, -12]
    });

    // Fetch Pothole Data
    async function fetchPotholeData(retries = 3) {
        try {
            const response = await fetch('pothole_data.json');
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            
            if (!data.length) {
                document.getElementById('loading').innerHTML = "‚ö† No pothole data available!";
                return;
            }
            
            document.getElementById('loading').style.display = 'none';
            displayPotholes(data);
            updateStats(data);
        } catch (error) {
            console.error(`‚ùå Error fetching JSON (attempts left: ${retries}):`, error);
            if (retries > 0) setTimeout(() => fetchPotholeData(retries - 1), 2000);
            else document.getElementById('loading').innerHTML = "‚ö† Failed to load data!";
        }
    }

    // Display Potholes
    function displayPotholes(data) {
        let bounds = [];

        data.forEach(loc => {
            if (typeof loc.lat === 'number' && typeof loc.lon === 'number') {
                let marker = L.marker([loc.lat, loc.lon], { icon: potholeIcon })
                    .bindPopup(`
                        <b>‚ö† Pothole Detected!</b><br>
                        <table style="width:100%;text-align:left;">
                            <tr><td>üìç Latitude:</td><td>${loc.lat.toFixed(6)}</td></tr>
                            <tr><td>üìç Longitude:</td><td>${loc.lon.toFixed(6)}</td></tr>
                            <tr><td>üõ† Distance 1:</td><td>${loc.distances[0]} cm</td></tr>
                            <tr><td>üõ† Distance 2:</td><td>${loc.distances[1]} cm</td></tr>
                            <tr><td>üõ† Distance 3:</td><td>${loc.distances[2]} cm</td></tr>
                        </table>
                    `);

                markers.addLayer(marker);
                bounds.push([loc.lat, loc.lon]);
            }
        });

        map.addLayer(markers);

        if (bounds.length === 1) {
            map.setView(bounds[0], 14);
        } else if (bounds.length > 1) {
            map.fitBounds(bounds);
        }
    }

    // Update Statistics
    function updateStats(data) {
        const total = data.length;
        const avgDepth = (data.reduce((sum, loc) => sum + Math.max(...loc.distances), 0) / total).toFixed(2);
        document.getElementById('total-count').textContent = total;
        document.getElementById('avg-depth').textContent = `${avgDepth} cm`;
    }

    // Locate User
    function locateUser() {
        if (!navigator.geolocation) {
            alert("‚ö† Geolocation is not supported by your browser.");
            return;
        }

        navigator.geolocation.getCurrentPosition(position => {
            let userLat = position.coords.latitude;
            let userLon = position.coords.longitude;
            let accuracy = position.coords.accuracy;

            if (userMarker) map.removeLayer(userMarker);
            if (accuracyCircle) map.removeLayer(accuracyCircle);

            userMarker = L.marker([userLat, userLon], { icon: userIcon })
                .addTo(map)
                .bindPopup(`<b>üìç You are here!</b><br>üìè Accuracy: ${Math.round(accuracy)} meters`).openPopup();

            accuracyCircle = L.circle([userLat, userLon], {
                color: 'blue',
                fillColor: '#30f',
                fillOpacity: 0.2,
                radius: accuracy
            }).addTo(map);

            map.setView([userLat, userLon], Math.min(15, map.getZoom()));
        }, error => {
            let errorMsg = "‚ö† Location access denied!";
            if (error.code === error.PERMISSION_DENIED) errorMsg = "‚ö† Please allow location access!";
            else if (error.code === error.POSITION_UNAVAILABLE) errorMsg = "‚ö† Location unavailable!";
            else if (error.code === error.TIMEOUT) errorMsg = "‚ö† Location request timed out!";
            
            alert(errorMsg);
        }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 });
    }

    // Toggle Sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.style.transform = sidebar.style.transform === 'translateX(0px)' ? 
            'translateX(-100%)' : 'translateX(0)';
    }

    // Toggle Dark Mode
    function toggleDarkMode() {
        const body = document.body;
        const isDark = !body.classList.contains('dark-mode');
        body.classList.toggle('dark-mode', isDark);
        document.querySelector('.leaflet-tile-container').classList.toggle('leaflet-dark', isDark);
        localStorage.setItem('darkMode', isDark);
    }

    // Show Report Form
    function showReportForm() {
        document.getElementById('report-form').style.display = 'block';
    }

    // Submit Report
    function submitReport() {
        const lat = parseFloat(document.getElementById('report-lat').value);
        const lon = parseFloat(document.getElementById('report-lon').value);
        const depth = parseFloat(document.getElementById('report-depth').value);

        if (isNaN(lat) || isNaN(lon) || isNaN(depth)) {
            alert("Please enter valid values!");
            return;
        }

        // Add marker for the new report
        L.marker([lat, lon], { icon: potholeIcon })
            .addTo(map)
            .bindPopup(`<b>‚ö† User-Reported Pothole!</b><br>Depth: ${depth} cm`)
            .openPopup();

        alert("Thank you for your report!");
        document.getElementById('report-form').style.display = 'none';
    }

    // Initialize Dark Mode
    function initDarkMode() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        document.body.classList.toggle('dark-mode', isDark);
        document.querySelector('.leaflet-tile-container').classList.toggle('leaflet-dark', isDark);
    }

    // Initialize
    initDarkMode();
    fetchPotholeData();
</script>

</body>
</html>